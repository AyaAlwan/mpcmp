---
title: "The `mpcmp` Package for Mean-Parametrizied Conway-Maxwell-Poisson Regression (under construction)"
author: "Thomas Fung, Aya Alwan, Justin Wishart and Alan Huang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: library.bib
fig_caption: yes
vignette: >
  %\VignetteIndexEntry{The <tt>`glm.cmp`</tt> Package for Mean-Parametrizied Conway-Maxwell-Poisson Regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

We review the theory and application of a mean-parametrized Conway-Maxwell-Poisson generalzied linear models for dispersed count data and describe the estimation of these models using the R package mpcmp. Prediction, inference, diagnostic and graphical methods are also illustrated by several examples. 

## Introduction 

Conway–Maxwell–Poisson (CMP or COM-Poisson) distributions have seen a recent resurgence in popularity for the analysis of dispersed counts (e.g., @Shmueli2005; @Lord2008, -@Lord2010; @Sellers2010). Key features of COM-Poisson distributions include the ability to handle both overdispersion and underdispersion, containing the classical Poisson distribution as a special case, and being a continuous bridge between other classical distributions such as the geometric and Bernoulli distributions. COM-Poisson distributions are also full probability models, making them particularly useful for predictions and estimation of event probabilities. See @Shmueli2005 for a more detailed overview of the history, features and applications of CMP distributions.

The CMP distribution was first used by Conway and Maxwell (1962) as a model for queueing system with dependent service times. A random variable is said to have a (standard) CMP distribution with rate parameter $\lambda$ and dispersion parameter $\nu$ if its probability mass function (pmf) is given by
$$
P(Y =y|λ,ν)= \frac{\lambda^y}{(y!)}\frac{1}{Z(\lambda,\nu)}, \quad y =0,1,2,...,
$$ 
where
$$
Z(\lambda,\nu)= \sum^{\infty}_{y=0}\frac{\lambda^y}{(y!)}.
$$
The CMP includes Poisson ($\nu = 1$), geometric ($\nu = 0$, $\lambda < 1$) and Bernoulli ($\nu \to \infty$ with probability $\lambda/(1+\lambda)$).

One of the major limitations of CMP distributions is that it is not directly parametrized via the mean. The two model parameters, namely, the rate $\lambda \geq  0$ and the dispersion $\nu \geq 0$, are interpreted through ratios of successive probabilities via
$$
\frac{P(Y = y − 1)}{P(Y= y)} = \frac{y^{\nu}}{\lambda}.
$$
As a result, the CMP generalises the Poisson such that the ratio is not necessarily linear in $y$. If $\nu < 1$, CMP would have a longer tail relative to a Poisson distribution with the same mean and is overdispersed. In reverse, CMP is underdispersed when $\nu >1$. Subsequently, we are interested to test whether a Poisson model is adequate, i.e. $\nu = 1$. 

The CMP distribution does not have closed-form expression for its moments in terms of the parameters $\lambda$ and $\nu$ but satisfy recursive formulas, (need some work here for the cases.)
$$
E(Y)  = \lambda E(Y+1)^{1-\nu};  \\\\
E(Y^{r+1}) =  \lambda\frac{d}{d\lambda}E(Y^r) + E(Y)E(Y^r),  \quad r>0.
$$
For the first two moments, approximation can be obtained as 
$$
E(Y)  = \frac{\partial \log Z}{\partial \log\lambda} \approx \lambda^{\frac{1}{\nu}}-\frac{\nu-1}{2\nu};\\
Var(Y)  = \frac{\partial^2\log Z}{\partial (\log \lambda)^2} \approx \frac{1}{\nu} \lambda^{\frac{1}{\nu}} \approx \frac{1}{\nu}E(Y),
$$
and they can be particularly accurate for $\nu\leq 1$ or $\lambda>10^{\nu}$ (see @Shmueli2005). It is obvious that $E(Y) \ne \lambda$ unless $\nu=1$ i.e. the Poisson special case. 

As CMP is one of a few distributions that can handle both under- and over-dispersion, the aim is to extend the GLM formulation to the CMP case so that one can model the relationship between $Y$ and the predictors $X$. Given a set of covariates $X \in R^q$, @Sellers2010  proposed a GLM for count response $Y$ that can be specified via
$$
Y|X ∼ CMP(\lambda,\nu), \quad \text{s.t.} \quad \log\lambda = X^{\top}\beta
$$ 
where $\beta \in R^q$ is a vector of regression coefficients. This model does not provide a closed form relationship between E(Y) and the linear predictor, making it incompatible with other commonly used log-linear model.

The `R` `mpcmp` 

The outline of the remainder of the paper is as follows. Section \@ref(mpcmpintro)

## Mean-Parametrized Conway-Maxwell-Poisson Regression {#mpcmpintro}
As it is more convenient and interpretable to model the mean $\mu = E(Y)$ of the distribution directly, @Huang2017b proposed to parametrize the CMP distribution via the mean:
$$
P(Y = y|\mu, \nu) = \frac{\lambda(\mu,\nu)^{y}}{(y!)^{\nu}}\frac{1}{Z(\lambda(\mu,\nu),\nu)}
$$
where the rate $\lambda(\mu,\nu)$ is defined as the solution to the mean constraint:
$$
 \mu= \sum^{\infty}_{y=0} y\frac{\lambda^y}{(y!)^{\nu}}\frac{1}{Z(\lambda,\nu)}, \quad y = 0,1,2,\ldots.
$$ 
We shall call this the CMP$_{\mu}$ distribution to distinguish it from the original/standard one.

A GLM that based on CMP$_{\mu}$ can then be specified via 

\begin{equation}
Y|X ∼ CMP(\mu(X^{\top}\beta),\nu)
\end{equation}
where
$$
E(Y|X) = \mu(X^{\top}\beta) = \exp(X^{\top}\beta).
$$
Note that GLM that based on CMP$_{\mu}$ is a genuine GLM, so the score equations for the regression parameters have the usual `weighted least-squares' form (cf. Fahrmeir and Kaufman, 1985) and can be solved using standard Newton–Raphson or Fisher scoring algorithms (see 

The mean-dispersion specification makes  directly comparable
and compatible other commonly used log-linear regression models for counts. In particular, the mean $\mu = \exp(X^{\top}\beta)$ is functionally independent of the dispersion parameter $\nu$, making it similar in structure to the familiar Negative Binomial regression model for overdispersed counts. 

Another advantage of modelling the mean directly is that it is way easier to incorporate offsets into the model. For example, suppose the count responses are collected over spatial regions of possibly different areas or time periods of possibly different durations.
Pros:
comparable and compatible with other log-linear models;
if $\nu$ is fixed, CMP$_{\mu}$ forms one-parameter exponential family;
the mean $\mu$ and dispersion $\nu$ are orthogonal (in contrast to the rate $\mu$ and $\nu$  in the standard CMP are not); easy to incorporate offsets into the model.

## Estimation 

## Distribution theory for likelihood estimation {#dist_theory}

For inference, @Huang2017b showed that the central limit theory for the likelihood estimates hold so that 
$$\binom{\widehat{\beta}}{\widehat{\nu}} \overset{d}{\approx} N\left(\binom{\beta}{\nu}, \widehat{\Omega}\right),$$
where the approximate covariance matrix is estimated by 
$$\widehat{\Omega} = -\left(D_{FS}(\widehat{\beta},\widehat{\nu})\right)^{-1}.$$ Thus a standard error for the maximum likelihood estimates of the *i*th component of $\beta$ is computed using $\widehat{\Omega}_{ii}^{\frac{1}{2}}$. 



## Modelling function in mpcmp 

The main modelling function for fitting mean-parametrized CMP models is `glm.cmp`. 

The object returned by any of the fitting routines is of class 'cmp'. To specify the model in a call to `glm.cmp`, a symbolic desciption of the model to be fitted needs to be provided as an object of class `formula`. An optional offset term Ot must be specified also. Initial values can be given for the coefficients in the regression component using the argument beta. 

A call is made to the Poisson GLM to obtain initial regression coefficient values and set $\nu=1$. 


Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Diagnostics 

### Likelihood ratio test 

### Probability integral transformation 

### Plots 

## Examples 

There are two examples datasets included in the `mpcmp` package which over over- and under-dispersed counts. Sample analyses for these datsets are provided in either the help page for the datasets or for the `glm.cmp()` function. 

### Overdispersed attendance data
```{r} 
library("mpcmp")
data("attendance")
M.attendance <- glm.cmp(daysabs~ gender+math+prog, data=attendance)
print(M.attendance)
summary(M.attendance)
```

### Underdispersed takeover bids data 

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold', fig.cap='test'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $$Y = X\beta + \epsilon$$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

The dispersion $\nu$ can in turn be modelled via its own regression model using a set of covariates $\tilte{X}$, with the natural link being $\nu = exp(\tilde{X}^{\top}\gamma))$ to ensure non-negativity. The set of covariates $\tilde{X}$ can coincide with $X$, share common
components with $X$, or be distinct altogether. 

## References

